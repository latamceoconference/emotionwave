<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Emotional Wave</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
/* ================= COMMON ================= */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #0b132b;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
  color: white;
}
.hidden { display: none !important; }

/* ================= GUEST ================= */
#guest {
  min-height: 100vh;
  background: radial-gradient(120% 120% at 50% 0%, #1c2541, #0b132b);
  display: flex;
  align-items: center;           /* ‚úÖ Ï†ïÏ§ëÏïô */
  justify-content: center;       /* ‚úÖ Ï†ïÏ§ëÏïô */
  padding: 20px;
}

.card {
  width: 100%;
  max-width: 420px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.18);
  border-radius: 24px;
  padding: 28px 24px 32px;
}

.card h1 {
  margin: 0 0 8px;
  text-align: center;
  font-size: 22px;
}

.subtitle {
  text-align: center;
  font-size: 14px;
  color: rgba(255,255,255,0.7);
  margin-bottom: 16px;
}

textarea {
  width: 100%;
  min-height: 90px;
  border-radius: 14px;
  border: none;
  background: rgba(255,255,255,0.12);
  color: white;
  padding: 14px;
  font-size: 14px;
  margin-bottom: 16px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

button {
  border: none;
  border-radius: 16px;
  padding: 16px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.calm { background:#4ea8de; }
.moved { background:#9d4edd; color:white; }
.joy { background:#ffd166; color:#333; }
.gratitude { background:#e9c46a; color:#333; }

/* ================= SCREEN ================= */
#screen {
  position: fixed;
  inset: 0;
}

canvas {
  width: 100%;
  height: 100%;
  display: block;
}

/* ===== LIVE MESSAGE (ÌÅ∞ Î©îÏãúÏßÄ) ===== */
#live-message {
  position: fixed;
  top: 20%;
  width: 100%;
  text-align: center;
  pointer-events: none;
}

.live {
  display: inline-block;
  padding: 16px 26px;
  font-size: 26px;
  background: rgba(0,0,0,0.4);
  border-radius: 28px;
  animation: fadeFloat 5s ease forwards;
}

@keyframes fadeFloat {
  0% { opacity:0; transform:translateY(20px); }
  10% { opacity:1; }
  80% { opacity:1; }
  100% { opacity:0; transform:translateY(-20px); }
}

/* ===== MESSAGE LOG ===== */
#message-log {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 720px;
  font-size: 16px;
  color: rgba(255,255,255,0.85);
}

.log-item {
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
</style>
</head>

<body>

<!-- ========== GUEST ========== -->
<div id="guest" class="hidden">
  <div class="card">
    <h1>Este momento √© feito por todos</h1>
    <div class="subtitle">
      Escreva uma mensagem e toque em uma emo√ß√£o
    </div>

    <textarea id="message" placeholder="Mensagem (opcional)"></textarea>

    <div class="grid">
      <button class="calm" onclick="sendEmotion('calm')">üíô Tranquilidade</button>
      <button class="moved" onclick="sendEmotion('moved')">‚ù§Ô∏è Emo√ß√£o</button>
      <button class="joy" onclick="sendEmotion('joy')">üíõ Alegria</button>
      <button class="gratitude" onclick="sendEmotion('gratitude')">ü§ç Gratid√£o</button>
    </div>
  </div>
</div>

<!-- ========== SCREEN ========== -->
<div id="screen" class="hidden">
  <canvas id="canvas"></canvas>
  <div id="live-message"></div>
  <div id="message-log"></div>
</div>

<script>
/* ================= MODE ================= */
const modeParam = new URLSearchParams(location.search).get("mode");
const mode = (modeParam === "screen") ? "screen" : "guest";

document.getElementById("guest").classList.add("hidden");
document.getElementById("screen").classList.add("hidden");
document.getElementById(mode).classList.remove("hidden");

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAYhMbJkSRs2uz-ZaAAbyAUrVjArqf1kZQ",
  authDomain: "emotional-wave-wedding.firebaseapp.com",
  databaseURL: "https://emotional-wave-wedding-default-rtdb.firebaseio.com",
  projectId: "emotional-wave-wedding",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= GUEST LOGIC ================= */
let lastSent = 0;
function sendEmotion(emotion) {
  const now = Date.now();
  if (now - lastSent < 700) return;
  lastSent = now;

  const textarea = document.getElementById("message");
  const msg = textarea.value.trim();

  db.ref("emotions").push({
    emotion,
    message: msg || null,
    time: now
  });

  textarea.value = "";
}

/* ================= SCREEN LOGIC ================= */
if (mode === "screen") {
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  function resize() {
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  }
  resize(); onresize = resize;

  const layers = {
    calm:{c:"#4ea8de",f:0.004},
    moved:{c:"#9d4edd",f:0.006},
    joy:{c:"#ffd166",f:0.009},
    gratitude:{c:"#e9c46a",f:0.003}
  };

  let energy=0, t=0;
  const log = [];

  db.ref("emotions").limitToLast(300).on("child_added", s => {
    const d = s.val();
    if (!d || !layers[d.emotion]) return;

    energy += 1.2;
    if (d.message) {
      showLive(d.message);
      addLog(d.message);
    }
  });

  function showLive(text) {
    const box = document.getElementById("live-message");
    box.innerHTML = `<div class="live">${text}</div>`;
  }

  function addLog(text) {
    log.unshift(text);
    if (log.length > 10) log.pop();
    document.getElementById("message-log").innerHTML =
      log.map(m => `<div class="log-item">${m}</div>`).join("");
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    energy *= 0.985; energy = Math.max(energy,0.3);

    Object.values(layers).forEach(l => {
      ctx.strokeStyle = l.c;
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      for (let x=0;x<canvas.width;x++) {
        ctx.lineTo(x, canvas.height/2 +
          Math.sin(x*l.f + t)*(80+energy*4));
      }
      ctx.stroke();
    });

    ctx.globalAlpha = 1;
    t += 0.01 + energy*0.002;
    requestAnimationFrame(draw);
  }
  draw();
}
</script>

</body>
</html>
