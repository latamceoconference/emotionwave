<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="format-detection" content="telephone=no,date=no,address=no,email=no" />

    <title>Convite de Casamento</title>
    <meta name="description" content="Com alegria, convidamos você para o nosso casamento. Informações, localização e mensagens." />

    <meta property="og:title" content="Convite de Casamento" />
    <meta property="og:description" content="Informações, localização e mensagens" />
    <meta property="og:type" content="website" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Optional: Firebase(Realtime Database) 공유 모드 사용 시에만 필요합니다. (README 참고) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <style>
      :root {
        --bg0: #fffdf8;
        --bg1: #fff7ef;
        --ink: #1f1d1a;
        --sub: #5c5248;
        --card: #ffffffcc;
        --shadow: 0 18px 50px rgba(31, 29, 26, 0.1);
        --accent: #c8a46b;
        --radius: 20px;
        --max: 980px;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        color: var(--ink);
        background: radial-gradient(900px 520px at 15% 0%, rgba(200, 164, 107, 0.18), transparent 60%),
          radial-gradient(900px 520px at 90% 10%, rgba(141, 106, 61, 0.14), transparent 60%),
          linear-gradient(180deg, var(--bg1), var(--bg0) 55%, #fff);
        font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: inherit;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .wrap {
        max-width: var(--max);
        margin: 0 auto;
        padding: 0 18px;
      }

      /* ====== Top Nav ====== */
      .topbar {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(14px);
        background: rgba(255, 255, 255, 0.75);
        border-bottom: 1px solid rgba(31, 29, 26, 0.08);
      }
      .topbar-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 0;
      }
      .brand {
        display: flex;
        align-items: baseline;
        gap: 10px;
        white-space: nowrap;
        min-width: 0;
      }
      .brand .title {
        font-family: "Playfair Display", serif;
        letter-spacing: 0.02em;
        font-size: 18px;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .brand .date {
        font-size: 12px;
        color: var(--sub);
        flex: 0 0 auto;
      }
      .nav {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .nav a {
        text-decoration: none;
        font-size: 13px;
        color: var(--sub);
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
      }
      .nav a:hover {
        border-color: rgba(31, 29, 26, 0.1);
        background: rgba(255, 255, 255, 0.55);
        color: var(--ink);
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
        min-width: 0;
      }

      .lang-switch {
        display: inline-flex;
        gap: 6px;
        padding: 4px;
        border-radius: 999px;
        border: 1px solid rgba(31, 29, 26, 0.12);
        background: rgba(255, 255, 255, 0.65);
      }
      .lang-btn {
        border: 1px solid transparent;
        background: transparent;
        color: var(--sub);
        padding: 7px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        letter-spacing: 0.02em;
      }
      .lang-btn:hover {
        border-color: rgba(31, 29, 26, 0.12);
        background: rgba(255, 255, 255, 0.8);
        color: var(--ink);
      }
      .lang-btn.active {
        background: linear-gradient(180deg, rgba(200, 164, 107, 0.25), rgba(200, 164, 107, 0.12));
        border-color: rgba(200, 164, 107, 0.55);
        color: var(--ink);
      }

      /* ====== Hero ====== */
      .hero {
        padding: 38px 0 14px;
      }
      .hero-grid {
        display: grid;
        grid-template-columns: 1.05fr 0.95fr;
        gap: 18px;
        align-items: stretch;
      }
      @media (max-width: 860px) {
        .hero-grid {
          grid-template-columns: 1fr;
        }
      }
      .hero-card {
        background: var(--card);
        border: 1px solid rgba(31, 29, 26, 0.1);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .hero-copy {
        padding: 28px 24px 24px;
      }
      .kicker {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--sub);
      }
      .kicker::before {
        content: "";
        width: 26px;
        height: 1px;
        background: rgba(31, 29, 26, 0.22);
        display: inline-block;
      }
      .names {
        margin: 12px 0 8px;
        font-family: "Playfair Display", serif;
        font-weight: 500;
        font-size: clamp(30px, 4.4vw, 44px);
        line-height: 1.12;
        letter-spacing: 0.02em;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      .names .and {
        display: inline-block;
        font-size: 20px;
        color: rgba(31, 29, 26, 0.55);
        margin: 0 10px;
        transform: translateY(-2px);
      }
      .meta {
        color: var(--sub);
        font-size: 15px;
        line-height: 1.7;
        margin: 0 0 18px;
      }
      .cta-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        appearance: none;
        border: 1px solid rgba(31, 29, 26, 0.14);
        background: rgba(255, 255, 255, 0.9);
        color: var(--ink);
        border-radius: 999px;
        padding: 11px 14px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: -0.01em;
        cursor: pointer;
        transition: transform 0.06s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      }
      .btn:active {
        transform: scale(0.98);
      }
      .btn.primary {
        border-color: rgba(200, 164, 107, 0.55);
        background: linear-gradient(180deg, rgba(200, 164, 107, 0.18), rgba(200, 164, 107, 0.08));
      }
      .btn.ghost {
        background: transparent;
      }
      .btn:hover {
        box-shadow: 0 10px 30px rgba(31, 29, 26, 0.1);
        border-color: rgba(31, 29, 26, 0.2);
        background: rgba(255, 255, 255, 0.95);
      }

      .hero-media {
        position: relative;
        min-height: 320px;
        background: radial-gradient(640px 360px at 20% 20%, rgba(200, 164, 107, 0.35), transparent 60%),
          radial-gradient(520px 340px at 90% 35%, rgba(141, 106, 61, 0.22), transparent 62%),
          linear-gradient(135deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.5));
      }
      .hero-media::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: var(--hero-image, url("assets/hero.jpg"));
        background-size: cover;
        background-position: center;
        opacity: 0.42;
        mix-blend-mode: normal;
        filter: saturate(1.08) contrast(1.08);
        pointer-events: none;
      }
      .hero-media-inner {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 18px;
        gap: 12px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(31, 29, 26, 0.1);
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: 0 12px 35px rgba(31, 29, 26, 0.1);
        color: var(--sub);
        font-size: 12px;
        white-space: nowrap;
      }
      .pill strong {
        color: var(--ink);
      }

      /* ====== Section ====== */
      section {
        padding: 18px 0;
      }
      .section-title {
        font-family: "Playfair Display", serif;
        font-weight: 500;
        letter-spacing: 0.02em;
        font-size: 22px;
        margin: 0 0 12px;
      }
      .section-sub {
        margin: -4px 0 14px;
        color: var(--sub);
        font-size: 14px;
        line-height: 1.7;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      @media (max-width: 860px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(31, 29, 26, 0.1);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px 16px;
      }
      .kv {
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 10px;
        align-items: start;
      }
      .kv .k {
        font-size: 13px;
        color: var(--sub);
      }
      .kv .v {
        font-size: 15px;
        line-height: 1.7;
        min-width: 0;
        overflow-wrap: anywhere;
      }

      .contact-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 2px 0;
      }
      .contact-main {
        display: flex;
        gap: 8px;
        align-items: baseline;
        min-width: 0;
        flex-wrap: wrap;
      }
      .contact-main .sep {
        color: rgba(31, 29, 26, 0.35);
      }
      .contact-actions {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        flex: 0 0 auto;
      }
      .icon-link {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: 1px solid rgba(31, 29, 26, 0.12);
        background: rgba(255, 255, 255, 0.92);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: transform 0.06s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }
      .icon-link:active {
        transform: scale(0.98);
      }
      .icon-link:hover {
        box-shadow: 0 10px 26px rgba(31, 29, 26, 0.12);
        border-color: rgba(31, 29, 26, 0.22);
      }
      .icon-link.whatsapp {
        border-color: rgba(37, 211, 102, 0.35);
      }
      .icon-link.whatsapp svg {
        width: 18px;
        height: 18px;
        fill: #25d366;
      }
      .hr {
        height: 1px;
        background: rgba(31, 29, 26, 0.1);
        margin: 14px 0;
      }
      .badge {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(31, 29, 26, 0.12);
        background: rgba(255, 255, 255, 0.7);
        font-size: 12px;
        color: var(--sub);
        white-space: nowrap;
      }
      .muted {
        color: var(--sub);
      }

      /* ====== Map ====== */
      .map {
        width: 100%;
        height: 320px;
        border-radius: 16px;
        border: 1px solid rgba(31, 29, 26, 0.1);
        overflow: hidden;
        background: linear-gradient(135deg, rgba(200, 164, 107, 0.08), rgba(141, 106, 61, 0.06));
      }
      .map iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }

      /* ====== Gallery ====== */
      .gallery {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 860px) {
        .gallery {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      .gitem {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(31, 29, 26, 0.1);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.35));
        min-height: 130px;
        cursor: pointer;
        padding: 0;
      }
      .gitem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transform: scale(1.01);
        transition: transform 0.35s ease, filter 0.35s ease;
        filter: saturate(1.02) contrast(1.03);
      }
      .gitem:hover img {
        transform: scale(1.06);
      }

      /* ====== Activity: Wave ====== */
      .wave-wrap {
        position: relative;
        border-radius: 18px;
        border: 1px solid rgba(31, 29, 26, 0.1);
        overflow: hidden;
        background: radial-gradient(900px 420px at 20% 20%, rgba(200, 164, 107, 0.2), transparent 60%),
          radial-gradient(760px 380px at 90% 40%, rgba(141, 106, 61, 0.14), transparent 62%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.35));
      }
      #waveCanvas {
        width: 100%;
        height: 260px;
        display: block;
      }
      .wave-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        padding: 14px;
        align-items: center;
        border-top: 1px solid rgba(31, 29, 26, 0.1);
        background: rgba(255, 255, 255, 0.72);
      }
      .wave-controls .field {
        flex: 1;
        min-width: 200px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      input[type="text"],
      textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(31, 29, 26, 0.14);
        background: rgba(255, 255, 255, 0.92);
        padding: 12px 12px;
        font-size: 14px;
        color: var(--ink);
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      textarea {
        min-height: 96px;
        resize: none;
      }
      input[type="text"]:focus,
      textarea:focus {
        border-color: rgba(200, 164, 107, 0.75);
        box-shadow: 0 0 0 4px rgba(200, 164, 107, 0.18);
      }
      .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .chip {
        border-radius: 999px;
        padding: 10px 12px;
        font-size: 13px;
        font-weight: 700;
        border: 1px solid rgba(31, 29, 26, 0.14);
        background: rgba(255, 255, 255, 0.94);
        cursor: pointer;
        transition: transform 0.06s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
      .chip:active {
        transform: scale(0.98);
      }
      .chip:hover {
        box-shadow: 0 10px 28px rgba(31, 29, 26, 0.1);
        border-color: rgba(31, 29, 26, 0.22);
      }
      .chip .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
      }
      .chip[data-emotion="calm"] .dot {
        background: #4ea8de;
      }
      .chip[data-emotion="moved"] .dot {
        background: #9d4edd;
      }
      .chip[data-emotion="joy"] .dot {
        background: #ffd166;
      }
      .chip[data-emotion="gratitude"] .dot {
        background: #e9c46a;
      }
      .note {
        font-size: 12px;
        color: var(--sub);
        line-height: 1.6;
        padding: 0 14px 14px;
      }

      /* ====== Poll ====== */
      .poll {
        display: grid;
        gap: 10px;
      }
      .poll-item {
        border: 1px solid rgba(31, 29, 26, 0.12);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.75);
        padding: 12px 12px;
        text-align: left;
        cursor: pointer;
      }
      .poll-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .poll-head strong {
        font-size: 14px;
      }
      .poll-head span {
        font-size: 12px;
        color: var(--sub);
      }
      .bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(31, 29, 26, 0.06);
        overflow: hidden;
        margin-top: 10px;
      }
      .bar > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(200, 164, 107, 0.85), rgba(141, 106, 61, 0.8));
        border-radius: 999px;
        transition: width 0.35s ease;
      }

      /* ====== Dialog ====== */
      dialog {
        width: min(560px, calc(100% - 24px));
        border: 1px solid rgba(31, 29, 26, 0.14);
        border-radius: 22px;
        padding: 0;
        box-shadow: 0 30px 90px rgba(31, 29, 26, 0.22);
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(14px);
      }
      dialog::backdrop {
        background: rgba(15, 14, 12, 0.35);
      }
      .dlg-head {
        padding: 16px 16px 12px;
        border-bottom: 1px solid rgba(31, 29, 26, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .dlg-head h3 {
        margin: 0;
        font-size: 16px;
      }
      .icon-btn {
        border: 1px solid rgba(31, 29, 26, 0.14);
        background: rgba(255, 255, 255, 0.85);
        border-radius: 12px;
        padding: 8px 10px;
        cursor: pointer;
      }
      .dlg-body {
        padding: 14px 16px 16px;
      }
      .row {
        display: grid;
        gap: 10px;
      }
      .row2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 520px) {
        .row2 {
          grid-template-columns: 1fr;
        }
      }
      .label {
        font-size: 12px;
        color: var(--sub);
      }
      .select {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(31, 29, 26, 0.14);
        background: rgba(255, 255, 255, 0.92);
        padding: 12px 12px;
        font-size: 14px;
        color: var(--ink);
      }
      .dlg-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(31, 29, 26, 0.14);
        border-radius: 999px;
        padding: 10px 12px;
        box-shadow: 0 18px 50px rgba(31, 29, 26, 0.18);
        font-size: 13px;
        color: var(--ink);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-6px);
      }

      /* ====== Screen mode ====== */
      .hidden {
        display: none !important;
      }
      #screen {
        width: 100%;
        height: 100vh;
        background: radial-gradient(120% 120% at 50% 0%, #1c2541, #0b132b);
        color: #fff;
      }
      #screen canvas {
        width: 100%;
        height: 100%;
        display: block;
      }
      #screen .overlay {
        position: fixed;
        bottom: 24px;
        width: 100%;
        text-align: center;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.65);
        pointer-events: none;
      }
      #message-layer {
        position: fixed;
        top: 18%;
        width: 100%;
        text-align: center;
        pointer-events: none;
      }
      .message {
        display: inline-block;
        max-width: min(70%, 900px);
        margin: 10px auto;
        padding: 14px 22px;
        font-size: 22px;
        line-height: 1.4;
        color: #fff;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(10px);
        border-radius: 26px;
        animation: fadeFloat 5s ease forwards;
      }
      @keyframes fadeFloat {
        0% {
          opacity: 0;
          transform: translateY(24px);
        }
        10% {
          opacity: 1;
          transform: translateY(0);
        }
        80% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateY(-24px);
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
          scroll-behavior: auto !important;
        }
      }

      /* ====== Mobile polish ====== */
      html {
        scroll-behavior: smooth;
      }
      @media (max-width: 560px) {
        /* Cards: unified left alignment on small phones */
        .card {
          text-align: left;
        }
        .card .section-title,
        .card .section-sub {
          text-align: left;
        }

        .topbar-inner {
          flex-wrap: wrap;
          align-items: flex-start;
          gap: 10px;
        }
        .brand {
          width: 100%;
          justify-content: space-between;
          align-items: center;
          gap: 12px;
        }
        .brand .title {
          max-width: 70%;
        }
        .brand .title {
          font-size: 16px;
        }
        .topbar-right {
          width: 100%;
          justify-content: space-between;
          align-items: center;
        }
        .nav {
          flex-wrap: nowrap;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          gap: 6px;
          padding-bottom: 2px;
          max-width: none;
          flex: 1 1 auto;
          min-width: 0;
        }
        .nav::-webkit-scrollbar {
          display: none;
        }
        .nav a {
          white-space: nowrap;
          padding: 7px 9px;
          font-size: 12px;
        }
        .hero-copy {
          padding: 22px 18px 18px;
          text-align: left;
        }
        .kicker {
          justify-content: flex-start;
          width: auto;
        }
        .names .and {
          display: block;
          margin: 6px 0;
          transform: none;
          font-size: 16px;
        }
        #groomName,
        #brideName {
          display: block;
        }
        .meta {
          font-size: 14px;
          text-align: left;
        }
        .cta-row {
          gap: 8px;
          justify-content: flex-start;
        }
        .cta-row .btn {
          flex: 1;
          justify-content: center;
        }
        .pill {
          padding: 9px 10px;
        }
        .map {
          height: 260px;
        }
        .gallery {
          gap: 8px;
        }
        .kv {
          grid-template-columns: 78px 1fr;
        }
        .contact-line {
          flex-wrap: wrap;
          align-items: flex-start;
        }
        .contact-main {
          flex: 1 1 auto;
          justify-content: flex-start;
          text-align: left;
        }
        .contact-actions {
          width: 100%;
          justify-content: flex-end;
          margin-top: 6px;
        }

        /* Hero media pills: prevent clipping on small screens */
        .hero-media {
          min-height: 380px;
        }
        .hero-media-inner {
          flex-direction: column;
          align-items: stretch;
          justify-content: flex-end;
          padding: 14px;
          padding-bottom: calc(14px + env(safe-area-inset-bottom));
          gap: 10px;
        }
        .pill {
          width: 100%;
          justify-content: space-between;
          padding: 10px 12px;
          font-size: 12px;
        }
      }
    </style>
  </head>

  <body>
    <!-- ====== Screen(행사장 디스플레이) 모드: ?mode=screen ====== -->
    <div id="screen" class="hidden" aria-hidden="true">
      <canvas id="canvas"></canvas>
      <div id="message-layer" aria-live="polite"></div>
      <div class="overlay" data-i18n="screen.overlay">Uma onda de felicitações, feita por todos</div>
    </div>

    <!-- ====== Invitation ====== -->
    <header class="topbar" id="top">
      <div class="wrap topbar-inner">
        <div class="brand" aria-label="Convite">
          <div class="title" id="brandTitle">Wedding Invitation</div>
          <div class="date" id="brandDate">2026. 05. 30</div>
        </div>
        <div class="topbar-right">
          <nav class="nav" aria-label="Navegação">
            <a href="#info" data-i18n="nav.info">Informações</a>
            <a href="#location" data-i18n="nav.location">Como chegar</a>
            <a href="#gallery" data-i18n="nav.gallery">Galeria</a>
            <a href="#activity" data-i18n="nav.activity">Participar</a>
            <a href="#gift" data-i18n="nav.gift">Presentes</a>
          </nav>
          <div class="lang-switch" role="group" aria-label="Idioma / País">
            <button class="lang-btn" type="button" data-country="BR">BR</button>
            <button class="lang-btn" type="button" data-country="KR">KR</button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="wrap">
          <div class="hero-grid">
            <div class="hero-card">
              <div class="hero-copy">
                <div class="kicker" data-i18n="hero.kicker">INVITATION</div>
                <h1 class="names">
                  <span id="groomName">Haseung Song</span>
                  <span class="and">&amp;</span>
                  <span id="brideName">Larissa Vilas Boas de Araujo</span>
                </h1>
                <p class="meta" id="heroMeta">
                  2026. 05. 30 (sáb) 16:30<br />
                  Rancho do Celso
                </p>
                <div class="cta-row">
                  <button class="btn" id="btnCalendar" type="button" data-i18n="hero.calendar">Adicionar ao calendário</button>
                  <a class="btn ghost" href="#activity" data-i18n="hero.join">Participar</a>
                  <a class="btn ghost" href="#location" data-i18n="hero.directions">Rotas</a>
                </div>
                <div class="hr"></div>
                <div class="badge" id="dataModeBadge" data-i18n="data.local">Dados: neste dispositivo (local)</div>
              </div>
            </div>

            <div class="hero-card hero-media" aria-label="대표 이미지 영역">
              <div class="hero-media-inner">
                <div class="pill">
                  <strong data-i18n="pill.ceremony">Cerimônia</strong>
                  <span id="pillDate">2026. 05. 30</span>
                </div>
                <div class="pill">
                  <strong data-i18n="pill.place">Local</strong>
                  <span id="pillPlace">Rancho do Celso</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="info">
        <div class="wrap">
          <h2 class="section-title" data-i18n="section.invite.title">Convidamos você</h2>
          <p class="section-sub" id="inviteText" data-i18n-html="section.invite.text">
            Duas histórias que caminharam separadas agora seguem lado a lado.<br />
            Gostaríamos de compartilhar este começo com pessoas especiais.<br />
            Sua presença será uma grande alegria.
          </p>

          <div class="grid2">
            <div class="card">
              <div class="kv">
                <div class="k" data-i18n="info.date.label">Data</div>
                <div class="v" id="infoDate">2026. 00. 00 (sáb) 00:00</div>
              </div>
              <div class="hr"></div>
              <div class="kv">
                <div class="k" data-i18n="info.place.label">Local</div>
                <div class="v">
                  <div id="infoPlace">Nome do local</div>
                  <div class="muted" id="infoAddr">
                    <a
                      id="infoMapLink"
                      href="#"
                      target="_blank"
                      rel="noreferrer"
                      style="text-decoration: underline"
                      data-i18n="info.mapLinkText"
                    >O Link</a>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="kv">
                <div class="k" data-i18n="info.contact.label">Contato</div>
                <div class="v">
                  <div class="contact-line">
                    <div class="contact-main">
                      <span data-i18n="info.contact.groom">Noivo</span>
                      <span class="sep">·</span>
                      <span id="groomContactName">Haseung Song</span>
                      <span class="sep">·</span>
                      <a id="groomTel" href="#" style="text-decoration: underline"><span id="groomPhone">010-0000-0000</span></a>
                    </div>
                    <div class="contact-actions">
                      <a
                        id="groomWhatsapp"
                        class="icon-link whatsapp"
                        href="#"
                        target="_blank"
                        rel="noreferrer"
                        aria-label="WhatsApp"
                        data-i18n-aria="aria.whatsapp"
                      >
                        <svg viewBox="0 0 32 32" aria-hidden="true">
                          <path
                            d="M19.11 17.29c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.61.14-.18.27-.7.88-.86 1.06-.16.18-.31.2-.58.07-.27-.14-1.12-.41-2.13-1.31-.79-.71-1.33-1.58-1.48-1.85-.16-.27-.02-.42.12-.55.12-.12.27-.31.41-.46.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.48-.84-2.03-.22-.53-.45-.46-.61-.47h-.52c-.18 0-.48.07-.73.34-.25.27-.95.93-.95 2.26s.98 2.62 1.12 2.8c.14.18 1.93 2.95 4.68 4.13.65.28 1.15.45 1.55.58.65.21 1.24.18 1.71.11.52-.08 1.6-.66 1.83-1.3.23-.64.23-1.18.16-1.3-.07-.12-.25-.2-.52-.34z"
                          />
                          <path
                            d="M26.67 5.33C23.83 2.5 20.06 1 16.04 1 7.9 1 1.3 7.6 1.3 15.74c0 2.6.68 5.14 1.97 7.38L1 31l8.08-2.22c2.17 1.19 4.62 1.81 7.1 1.81h.01c8.14 0 14.74-6.6 14.74-14.74 0-3.99-1.55-7.75-4.26-10.52zm-10.62 22.7h-.01c-2.22 0-4.4-.6-6.29-1.73l-.45-.27-4.79 1.32 1.28-4.67-.29-.48a12.17 12.17 0 0 1-1.85-6.46c0-6.71 5.46-12.17 12.18-12.17 3.25 0 6.31 1.26 8.59 3.54 2.28 2.29 3.54 5.34 3.54 8.6 0 6.71-5.46 12.17-12.11 12.32z"
                          />
                        </svg>
                      </a>
                    </div>
                  </div>

                  <div class="contact-line">
                    <div class="contact-main">
                      <span data-i18n="info.contact.bride">Noiva</span>
                      <span class="sep">·</span>
                      <span id="brideContactName">Larissa vilas boas de araujo</span>
                      <span class="sep">·</span>
                      <a id="brideTel" href="#" style="text-decoration: underline"><span id="bridePhone">010-0000-0000</span></a>
                    </div>
                    <div class="contact-actions">
                      <a
                        id="brideWhatsapp"
                        class="icon-link whatsapp"
                        href="#"
                        target="_blank"
                        rel="noreferrer"
                        aria-label="WhatsApp"
                        data-i18n-aria="aria.whatsapp"
                      >
                        <svg viewBox="0 0 32 32" aria-hidden="true">
                          <path
                            d="M19.11 17.29c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.61.14-.18.27-.7.88-.86 1.06-.16.18-.31.2-.58.07-.27-.14-1.12-.41-2.13-1.31-.79-.71-1.33-1.58-1.48-1.85-.16-.27-.02-.42.12-.55.12-.12.27-.31.41-.46.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.48-.84-2.03-.22-.53-.45-.46-.61-.47h-.52c-.18 0-.48.07-.73.34-.25.27-.95.93-.95 2.26s.98 2.62 1.12 2.8c.14.18 1.93 2.95 4.68 4.13.65.28 1.15.45 1.55.58.65.21 1.24.18 1.71.11.52-.08 1.6-.66 1.83-1.3.23-.64.23-1.18.16-1.3-.07-.12-.25-.2-.52-.34z"
                          />
                          <path
                            d="M26.67 5.33C23.83 2.5 20.06 1 16.04 1 7.9 1 1.3 7.6 1.3 15.74c0 2.6.68 5.14 1.97 7.38L1 31l8.08-2.22c2.17 1.19 4.62 1.81 7.1 1.81h.01c8.14 0 14.74-6.6 14.74-14.74 0-3.99-1.55-7.75-4.26-10.52zm-10.62 22.7h-.01c-2.22 0-4.4-.6-6.29-1.73l-.45-.27-4.79 1.32 1.28-4.67-.29-.48a12.17 12.17 0 0 1-1.85-6.46c0-6.71 5.46-12.17 12.18-12.17 3.25 0 6.31 1.26 8.59 3.54 2.28 2.29 3.54 5.34 3.54 8.6 0 6.71-5.46 12.17-12.11 12.32z"
                          />
                        </svg>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="kv">
                <div class="k" data-i18n="info.note.label">Aviso</div>
                <div class="v muted" id="infoNote" data-i18n="info.noteText">Estacionamento no local do evento</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="location">
        <div class="wrap">
          <h2 class="section-title" data-i18n="section.location.title">Como chegar</h2>
          <p class="section-sub" data-i18n="section.location.sub">Substitua pelo link de incorporação (embed) do mapa do local.</p>

          <div class="grid2">
            <div class="card">
              <div class="map" aria-label="지도">
                <iframe
                  id="mapFrame"
                  title="지도"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  src="about:blank"
                ></iframe>
              </div>
              <div class="hr"></div>
              <div class="cta-row">
                <a class="btn" id="btnNavi" href="#" target="_blank" rel="noreferrer" data-i18n="location.route">Abrir rotas</a>
                <button class="btn" id="btnCopyAddr" type="button" data-i18n="location.copy">Copiar endereço</button>
                <button class="btn" id="btnCopyMapLink" type="button" data-i18n="location.copyLink">Copiar link do mapa</button>
                <button class="btn ghost" id="btnShareMap" type="button" data-i18n="location.share">Compartilhar</button>
              </div>
              <div class="muted" style="font-size: 12px; margin-top: 10px; line-height: 1.6">
                <span data-i18n="location.linkLabel">Link do Google Maps:</span>
                <a id="mapLinkText" href="#" target="_blank" rel="noreferrer" style="text-decoration: underline">Abrir</a>
              </div>
            </div>

            <!-- (removed) Transit info card -->
          </div>
        </div>
      </section>

      <section id="gallery">
        <div class="wrap">
          <h2 class="section-title" data-i18n="section.gallery.title">Galeria</h2>
          <p class="section-sub" data-i18n="section.gallery.sub">Coloque fotos como `assets/gallery/01.jpg` e elas aparecerão automaticamente. (Veja o README)</p>

          <div class="card">
            <div class="gallery" id="galleryGrid" aria-label="Galeria"></div>
          </div>
        </div>
      </section>

      <section id="activity">
        <div class="wrap">
          <h2 class="section-title" data-i18n="section.activity.title">Um momento feito por todos</h2>
          <p class="section-sub" data-i18n="section.activity.sub">
            Confirme presença, deixe uma mensagem e participe da “onda de felicitações”.
          </p>

          <div class="grid2">
            <div class="card">
              <h3 class="section-title" style="font-size: 18px; margin-top: 0" data-i18n="wave.title">Onda de felicitações</h3>
              <div class="wave-wrap" role="region" aria-label="축하 파도 참여">
                <canvas id="waveCanvas" width="1200" height="520"></canvas>
                <div class="wave-controls">
                  <div class="field">
                    <input
                      id="waveMessage"
                      type="text"
                      maxlength="60"
                      placeholder="Uma mensagem curta (opcional)"
                      data-i18n-placeholder="wave.placeholder"
                    />
                  </div>
                  <div class="chips" aria-label="감정 선택">
                    <button class="chip" type="button" data-emotion="calm"><span class="dot" aria-hidden="true"></span><span data-i18n="emotion.calm">Calma</span></button>
                    <button class="chip" type="button" data-emotion="moved"><span class="dot" aria-hidden="true"></span><span data-i18n="emotion.moved">Emoção</span></button>
                    <button class="chip" type="button" data-emotion="joy"><span class="dot" aria-hidden="true"></span><span data-i18n="emotion.joy">Alegria</span></button>
                    <button class="chip" type="button" data-emotion="gratitude"><span class="dot" aria-hidden="true"></span><span data-i18n="emotion.gratitude">Gratidão</span></button>
                  </div>
                </div>
                <div class="note" id="waveNote">
                  Modo local. Para juntar participação de todos, ative o modo compartilhado (Firebase). (Veja o README)
                </div>
              </div>
            </div>

            <div class="card">
              <h3 class="section-title" style="font-size: 18px; margin-top: 0" data-i18n="poll.title">Votação de palavras</h3>
              <p class="section-sub" style="margin-top: 0" data-i18n="poll.sub">Escolha uma. O resultado atualiza automaticamente.</p>
              <div class="poll" id="poll"></div>
              <div class="cta-row" style="margin-top: 12px">
                <button class="btn" id="btnExport" type="button" data-i18n="poll.export">Exportar meus dados</button>
                <button class="btn ghost" id="btnClearLocal" type="button" data-i18n="poll.clear">Limpar dados deste dispositivo</button>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="card">
              <h3 class="section-title" style="font-size: 18px; margin-top: 0" data-i18n="guestbook.title">Mensagem</h3>
              <div class="row">
                <div>
                  <div class="label" data-i18n="guestbook.name.label">Nome</div>
                  <input id="gbName" type="text" maxlength="16" placeholder="Seu nome (opcional)" data-i18n-placeholder="guestbook.name.ph" />
                </div>
                <div>
                  <div class="label" data-i18n="guestbook.msg.label">Mensagem</div>
                  <textarea id="gbMessage" maxlength="200" placeholder="Deixe sua mensagem" data-i18n-placeholder="guestbook.msg.ph"></textarea>
                </div>
                <div class="cta-row">
                  <button class="btn primary" id="btnGbSubmit" type="button" data-i18n="guestbook.submit">Enviar</button>
                </div>
                <div class="hr"></div>
                <div id="guestbookList" class="row" aria-label="방명록 목록"></div>
              </div>
            </div>

            <!-- (removed) RSVP card -->
          </div>
        </div>
      </section>

      <section id="gift">
        <div class="wrap">
          <h2 class="section-title" data-i18n="section.gift.title">Presentes</h2>
          <p class="section-sub" data-i18n="section.gift.sub">Use o botão “Copiar” para copiar os dados com segurança.</p>

          <div class="grid2">
            <div class="card">
              <h3 class="section-title" style="font-size: 18px; margin-top: 0" data-i18n="gift.groom.side">Lado do noivo</h3>
              <div class="kv">
                <div class="k" data-i18n="gift.holder">Titular</div>
                <div class="v" id="groomHolder">홍길동</div>
              </div>
              <div class="hr"></div>
              <div class="kv">
                <div class="k" data-i18n="gift.account">Conta</div>
                <div class="v">
                  <div id="groomBank">은행명 000-000-000000</div>
                  <div class="cta-row" style="margin-top: 10px">
                    <button class="btn" type="button" data-copy="#groomBank" data-i18n="common.copy">Copiar</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <h3 class="section-title" style="font-size: 18px; margin-top: 0" data-i18n="gift.bride.side">Lado da noiva</h3>
              <div class="kv">
                <div class="k" data-i18n="gift.holder">Titular</div>
                <div class="v" id="brideHolder">김영희</div>
              </div>
              <div class="hr"></div>
              <div class="kv">
                <div class="k" data-i18n="gift.account">Conta</div>
                <div class="v">
                  <div id="brideBank">은행명 000-000-000000</div>
                  <div class="cta-row" style="margin-top: 10px">
                    <button class="btn" type="button" data-copy="#brideBank" data-i18n="common.copy">Copiar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section>
        <div class="wrap">
          <div class="card" style="text-align: center">
            <div class="muted" style="font-size: 13px; line-height: 1.8" data-i18n-html="section.footer.note">
              Esta página é um único `index.html`, pronta para GitHub Pages.<br />
              Modo tela: adicione `?mode=screen` no final da URL.
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- ====== Lightbox ====== -->
    <dialog id="dlgLightbox" aria-label="Imagem">
      <div class="dlg-head">
        <h3 data-i18n="dlg.photo.title">Foto</h3>
        <button class="icon-btn" type="button" data-close="dlgLightbox" aria-label="Fechar" data-i18n="common.close">Fechar</button>
      </div>
      <div class="dlg-body">
        <img
          id="lightboxImg"
          alt="Imagem ampliada"
          data-i18n-alt="dlg.photo.alt"
          style="width: 100%; border-radius: 16px; border: 1px solid rgba(31, 29, 26, 0.1)"
        />
        <div class="muted" style="font-size: 12px; margin-top: 10px">
          <span data-i18n="dlg.photo.hint">Feche e selecione outra foto para ver mais.</span>
        </div>
      </div>
    </dialog>

    <div class="toast" id="toast" role="status" aria-live="polite">Concluído</div>

    <script>
      // ================== CONFIG (여기만 수정하면 됩니다) ==================
      const WEDDING = {
        groomName: "Haseung Song",
        brideName: "Larissa Vilas Boas de Araujo",
        dateText: "2026. 05. 30 (sáb) 16:30",
        dateISO: "2026-05-30T16:30:00-03:00", // 캘린더용 (브라질 기준 예시)
        placeText: "Rancho do Celso - Rifaina/SP",
        placeShort: "Rancho do Celso - Rifaina/SP",
        addressText: "Rancho do Celso - Rifaina/SP",
        naviLink: "https://goo.gl/maps/Eir3bNDdSjEec3YJA?g_st=aw",
        mapEmbedUrl:
          "https://www.google.com/maps/embed?pb=!1m17!1m12!1m3!1d3747.480863602356!2d-47.428118924769045!3d-20.07217598134847!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m2!1m1!2zMjDCsDA0JzE5LjgiUyA0N8KwMjUnMzIuMCJX!5e0!3m2!1sko!2sbr!4v1770246189302!5m2!1sko!2sbr", // 구글 지도 퍼가기(Embed) iframe의 src
        // 연락처(브라질): WhatsApp/전화 링크가 잘 되려면 국가코드 포함 추천 (+55 ...)
        phone: { groom: "+55 11 98145-1081", bride: "+55 11 98811-2997" },
        gift: {
          groomHolder: "Haseung Song (Nubank)",
          groomBank: "70399339183",
          brideHolder: "Larissa Vilas Boas de Araujo (Nubank)",
          brideBank: "32346800864",
        },

        // Firebase 공유 모드 (선택): README대로 세팅 후 값 입력
        firebase: {
          enabled: false,
          config: {
            apiKey: "",
            authDomain: "",
            databaseURL: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
          },
        },

        // 갤러리 자동 탐색 (1~11, 01~11, jpg/jpeg 모두 지원)
        galleryAutoMax: 11,
        // 특정 파일만 고정으로 쓰고 싶으면 아래처럼 직접 배열을 넣으면 됩니다.
        // galleryFiles: ["assets/gallery/01.jpg", "assets/gallery/02.jpg"],

        // 히어로 이미지 후보 (먼저 존재하는 파일을 사용)
        heroImageCandidates: ["assets/hero.jpg", "hero.jpg", "01.jpg", "02.jpg"],
      };

      // ================== MODE ==================
      const params = new URLSearchParams(location.search);
      const mode = params.get("mode") === "screen" ? "screen" : "invitation";

      const screenEl = document.getElementById("screen");
      if (mode === "screen") {
        screenEl.classList.remove("hidden");
        screenEl.removeAttribute("aria-hidden");
        document.querySelector("header.topbar")?.classList.add("hidden");
        document.querySelector("main")?.classList.add("hidden");
      } else {
        screenEl.classList.add("hidden");
        screenEl.setAttribute("aria-hidden", "true");
      }

      // ================== UTIL ==================
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      // ================== I18N (Default: Portuguese / BR) ==================
      const COUNTRY_STORAGE_KEY = "wedding.country.v1";
      const COUNTRY_TO_LANG = { BR: "pt", KR: "ko" };

      const I18N = {
        pt: {
          meta: {
            title: "Convite de Casamento",
            description: "Com alegria, convidamos você para o nosso casamento. Informações, localização e mensagens.",
            ogTitle: "Convite de Casamento",
            ogDescription: "Informações, localização e mensagens",
          },
          screen: { overlay: "Uma onda de felicitações, feita por todos" },
          nav: { info: "Informações", location: "Como chegar", gallery: "Galeria", activity: "Participar", gift: "Presentes" },
          hero: { kicker: "INVITATION", calendar: "Adicionar ao calendário", join: "Participar", directions: "Rotas" },
          data: {
            local: "Evento ao ar livre – sapato confortável recomendado",
            shared: "Dados: compartilhado (Firebase)",
            noteLocal: "Modo local. Para juntar participação de todos, ative o modo compartilhado (Firebase). (Veja o README)",
            noteShared: "Modo compartilhado. A participação de todos aparece em tempo real.",
            hintLocal: "No modo local, salva apenas neste dispositivo. No modo compartilhado (Firebase), soma respostas de todos.",
            hintShared: "Modo compartilhado: respostas de todos ficam reunidas.",
          },
          pill: { ceremony: "Cerimônia", place: "Local" },
          section: {
            invite: {
              title: "Convidamos você",
              text:
                "Duas histórias que caminharam separadas agora seguem lado a lado.<br />Gostaríamos de compartilhar este começo com pessoas especiais.<br />Sua presença será uma grande alegria.",
            },
            location: { title: "Como chegar", sub: "Por favor, consulte o local abaixo para participar do evento.", route: "Abrir rotas", copy: "Copiar endereço", transitTitle: "Transporte" },
            gallery: { title: "Galeria", sub: "Aqui estão as fotos dos nossos momentos especiais." },
            activity: { title: "Um momento feito por todos", sub: "Confirme presença, deixe uma mensagem e participe da “onda de felicitações”." },
            gift: { title: "Presentes", sub: "Use o botão “Copiar” para copiar os dados com segurança." },
            footer: { note: "Esta página é um único `index.html`, pronta para GitHub Pages.<br />Modo tela: adicione `?mode=screen` no final da URL." },
          },
          info: {
            dateLabel: "Data",
            placeLabel: "Local",
            contactLabel: "Contato",
            contactGroom: "Noivo",
            contactBride: "Noiva",
            noteLabel: "Aviso",
            mapLinkText: "O Link",
            noteText: "Estacionamento no local do evento",
          },
          location: {
            route: "Abrir no Google Maps",
            copy: "Copiar endereço",
            copyLink: "Copiar link do mapa",
            share: "Compartilhar",
            linkLabel: "Link do Google Maps:",
            transit: {
              subway: "Metrô",
              subwayEx: "Ex) Linha X, Estação Y, 5 min a pé",
              bus: "Ônibus",
              busEx: "Ex) 000, 000, 000 (ponto)",
              parking: "Estacionamento",
              parkingEx: "Ex) 2h grátis / recomendado transporte público",
            },
          },
          wave: { title: "Onda de felicitações", placeholder: "Uma mensagem curta (opcional)" },
          emotion: { calm: "Calma", moved: "Emoção", joy: "Alegria", gratitude: "Gratidão" },
          poll: {
            title: "Votação de palavras",
            sub: "Escolha uma. O resultado atualiza automaticamente.",
            export: "Exportar meus dados",
            clear: "Limpar dados deste dispositivo",
            option: { warm: "Um começo acolhedor", bright: "Um dia brilhante", calm: "Felicidade tranquila", fun: "Memórias divertidas" },
            votes: "{count} voto(s) · {pct}%",
            ariaVote: "Votar: {label}",
          },
          guestbook: {
            title: "Mensagem",
            nameLabel: "Nome",
            namePh: "Seu nome (opcional)",
            msgLabel: "Mensagem",
            msgPh: "Deixe sua mensagem",
            submit: "Enviar",
            empty: "Ainda não há mensagens. Seja o(a) primeiro(a)!",
            anonymous: "Anônimo",
          },
          dlg: {
            photo: { title: "Foto", hint: "Feche e selecione outra foto para ver mais.", alt: "Imagem ampliada" },
          },
          gift: { groomSide: "Lado do noivo", brideSide: "Lado da noiva", holder: "Titular", account: "Conta" },
          common: { copy: "Copiar", close: "Fechar", save: "Salvar" },
          toast: {
            copied: "Copiado",
            copyFail: "Falha ao copiar",
            checkInput: "Verifique os dados",
            needDateISO: "Defina o dateISO",
            downloaded: "Arquivo do calendário baixado",
            needMessage: "Digite uma mensagem",
            leftMessage: "Enviado",
            cleared: "Limpo",
            voted: "Votado",
            joined: "Participação enviada",
          },
          gallery: { needFiles: "Adicione fotos em assets/gallery/", open: "Abrir foto", alt: "Foto da galeria" },
          aria: { whatsapp: "Abrir conversa no WhatsApp" },
        },
        ko: {
          meta: {
            title: "결혼식에 초대합니다",
            description: "소중한 분들을 결혼식에 초대합니다. 일정, 오시는 길, 축하 메시지와 참여형 액티비티를 확인하세요.",
            ogTitle: "결혼식에 초대합니다",
            ogDescription: "일정, 오시는 길, 축하 메시지",
          },
          screen: { overlay: "함께 만드는 축하의 파도" },
          nav: { info: "안내", location: "오시는 길", gallery: "갤러리", activity: "참여", gift: "마음 전하실 곳" },
          hero: { kicker: "INVITATION", calendar: "캘린더 추가", join: "축하 참여하기", directions: "길찾기" },
          data: {
            local: "야외 행사입니다 — 편한 신발을 추천드려요",
            shared: "데이터 저장: 공유(Firebase)",
            noteLocal: "현재는 “로컬 저장” 모드입니다. 여러 사람의 참여를 모으려면 Firebase 공유 모드를 설정해 주세요. (README 참고)",
            noteShared: "지금은 “공유 모드”입니다. 여러 사람의 참여가 실시간으로 모입니다.",
            hintLocal: "로컬 모드: 이 기기에서만 저장됩니다. 공유 모드를 켜면 여러 사람의 RSVP가 모입니다.",
            hintShared: "공유 모드: 여러 사람의 RSVP가 한 곳에 모입니다.",
          },
          pill: { ceremony: "예식", place: "장소" },
          section: {
            invite: {
              title: "초대합니다",
              text: "서로 다른 길을 걸어온 두 사람이 한 길을 걷기로 했습니다.<br />소중한 분들과 함께 그 시작을 나누고 싶습니다.<br />귀한 걸음으로 자리를 빛내 주세요.",
            },
            location: { title: "오시는 길", sub: "아래 장소를 참고 해서 행사 참석 바랍니다.", route: "길찾기 링크", copy: "주소 복사", transitTitle: "교통 안내" },
            gallery: { title: "갤러리", sub: "우리들의 특별한 순간을 담은 사진들입니다." },
            activity: { title: "함께 만드는 순간", sub: "참석 여부를 남기거나, 축하 메시지를 전해 주세요. “축하 파도” 버튼을 누르면 이 순간이 조금 더 반짝입니다." },
            gift: { title: "마음 전하실 곳", sub: "계좌번호는 “복사” 버튼으로 안전하게 복사할 수 있습니다." },
            footer: { note: "이 페이지는 단일 `index.html`로 구성되어 GitHub Pages에 바로 올릴 수 있습니다.<br />화면용 모드: URL 뒤에 `?mode=screen`" },
          },
          info: {
            dateLabel: "일시",
            placeLabel: "장소",
            contactLabel: "연락처",
            contactGroom: "신랑",
            contactBride: "신부",
            noteLabel: "안내",
            mapLinkText: "링크",
            noteText: "행사장 내 주차가 가능합니다.",
          },
          location: {
            route: "구글 지도 열기",
            copy: "주소 복사",
            copyLink: "지도 링크 복사",
            share: "공유하기",
            linkLabel: "구글 지도 링크:",
            transit: {
              subway: "지하철",
              subwayEx: "예) 0호선 0역 0번 출구 도보 5분",
              bus: "버스",
              busEx: "예) 000, 000, 000 (정류장명)",
              parking: "주차",
              parkingEx: "예) 2시간 무료 / 혼잡 예상, 대중교통 권장",
            },
          },
          wave: { title: "축하 파도", placeholder: "짧은 축하 한 줄 (선택)" },
          emotion: { calm: "차분함", moved: "감동", joy: "기쁨", gratitude: "감사" },
          poll: {
            title: "축하 키워드 투표",
            sub: "하나를 골라 주세요. 결과는 자동으로 반영됩니다.",
            export: "내 데이터 내보내기",
            clear: "이 기기 데이터 초기화",
            option: { warm: "따뜻한 시작", bright: "반짝이는 하루", calm: "편안한 행복", fun: "즐거운 추억" },
            votes: "{count}표 · {pct}%",
            ariaVote: "{label} 투표",
          },
          guestbook: {
            title: "축하 메시지",
            nameLabel: "이름",
            namePh: "성함 (선택)",
            msgLabel: "메시지",
            msgPh: "따뜻한 마음을 남겨 주세요",
            submit: "메시지 남기기",
            empty: "아직 메시지가 없습니다. 첫 메시지를 남겨 주세요.",
            anonymous: "익명",
          },
          dlg: {
            photo: { title: "사진", hint: "사진을 넘기려면 바깥을 닫고 다른 사진을 선택해 주세요.", alt: "확대 이미지" },
          },
          gift: { groomSide: "신랑 측", brideSide: "신부 측", holder: "예금주", account: "계좌" },
          common: { copy: "복사", close: "닫기", save: "저장" },
          toast: {
            copied: "복사했습니다",
            copyFail: "복사에 실패했습니다",
            checkInput: "입력값을 확인해 주세요",
            needDateISO: "dateISO를 설정해 주세요",
            downloaded: "캘린더 파일을 내려받았습니다",
            needMessage: "메시지를 입력해 주세요",
            leftMessage: "남겼습니다",
            cleared: "초기화했습니다",
            voted: "투표했습니다",
            joined: "참여했습니다",
          },
          gallery: { needFiles: "assets/gallery/에 사진을 넣어주세요", open: "사진 확대", alt: "갤러리 사진" },
          aria: { whatsapp: "WhatsApp으로 바로 연락하기" },
        },
      };

      let currentCountry = "BR";
      let currentLang = "pt";

      function t(key, vars = {}) {
        const parts = String(key).split(".");
        let cur = I18N[currentLang];
        for (const p of parts) cur = cur?.[p];
        const raw = typeof cur === "string" ? cur : "";
        return raw.replace(/\{(\w+)\}/g, (_, k) => (vars[k] == null ? "" : String(vars[k])));
      }

      function setMeta() {
        document.title = t("meta.title");
        const desc = document.querySelector('meta[name="description"]');
        desc && desc.setAttribute("content", t("meta.description"));
        const ogt = document.querySelector('meta[property="og:title"]');
        ogt && ogt.setAttribute("content", t("meta.ogTitle"));
        const ogd = document.querySelector('meta[property="og:description"]');
        ogd && ogd.setAttribute("content", t("meta.ogDescription"));
      }

      function applyI18n() {
        document.documentElement.lang = currentLang === "ko" ? "ko" : "pt-BR";
        setMeta();

        $$("[data-i18n]").forEach((el) => {
          el.textContent = t(el.getAttribute("data-i18n"));
        });
        $$("[data-i18n-html]").forEach((el) => {
          el.innerHTML = t(el.getAttribute("data-i18n-html"));
        });
        $$("[data-i18n-placeholder]").forEach((el) => {
          el.setAttribute("placeholder", t(el.getAttribute("data-i18n-placeholder")));
        });
        $$("[data-i18n-alt]").forEach((el) => {
          el.setAttribute("alt", t(el.getAttribute("data-i18n-alt")));
        });
        $$("[data-i18n-aria]").forEach((el) => {
          el.setAttribute("aria-label", t(el.getAttribute("data-i18n-aria")));
        });

        // 버튼 활성 표시
        $$(".lang-btn").forEach((b) => {
          const c = (b.getAttribute("data-country") || "").toUpperCase();
          b.classList.toggle("active", c === currentCountry);
        });
      }

      function resolveInitialCountry() {
        const c = String(params.get("country") || "").toUpperCase();
        if (c === "KR" || c === "BR") return c;
        const lang = String(params.get("lang") || "").toLowerCase();
        if (lang === "ko") return "KR";
        if (lang === "pt") return "BR";
        const saved = String(localStorage.getItem(COUNTRY_STORAGE_KEY) || "").toUpperCase();
        if (saved === "KR" || saved === "BR") return saved;
        return "BR"; // default: Portuguese
      }

      function initCountry(country) {
        const next = String(country || "").toUpperCase();
        if (next !== "KR" && next !== "BR") return;
        currentCountry = next;
        currentLang = COUNTRY_TO_LANG[next] || "pt";
        localStorage.setItem(COUNTRY_STORAGE_KEY, next);
        applyI18n();
      }

      function setCountry(country) {
        const next = String(country || "").toUpperCase();
        if (next !== "KR" && next !== "BR") return;
        initCountry(next);
        // country 변경 시 WhatsApp/전화/지도 링크 등 동적 링크도 갱신
        bindContent();
        setDataModeUI();
        renderPoll();
        renderGuestbook();
        if (mode !== "screen") buildGallery();
      }

      function toast(text) {
        const t = $("#toast");
        if (!t) return;
        t.textContent = text;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => t.classList.remove("show"), 2200);
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          toast(t("toast.copied"));
          return true;
        } catch {
          try {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            ta.remove();
            toast(t("toast.copied"));
            return true;
          } catch {
            toast(t("toast.copyFail"));
            return false;
          }
        }
      }

      function openDialog(id) {
        const dlg = document.getElementById(id);
        if (!dlg) return;
        if (typeof dlg.showModal === "function") dlg.showModal();
        else dlg.setAttribute("open", "open");
      }

      function closeDialog(id) {
        const dlg = document.getElementById(id);
        if (!dlg) return;
        if (typeof dlg.close === "function") dlg.close();
        else dlg.removeAttribute("open");
      }

      function safeJsonParse(str, fallback) {
        try {
          return JSON.parse(str);
        } catch {
          return fallback;
        }
      }

      const ASSET_CACHE_BUSTER = String(Date.now());

      function escapeHtml(str) {
        return String(str || "").replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
      }

      // ================== DATA PROVIDER ==================
      const LS_KEYS = {
        emotions: "wedding.emotions.v1",
        guestbook: "wedding.guestbook.v1",
        poll: "wedding.poll.v1",
      };

      const EMOTIONS = {
        calm: { label: "차분함", color: "#4ea8de", freq: 0.004 },
        moved: { label: "감동", color: "#9d4edd", freq: 0.006 },
        joy: { label: "기쁨", color: "#ffd166", freq: 0.009 },
        gratitude: { label: "감사", color: "#e9c46a", freq: 0.003 },
      };

      const POLL_OPTIONS = ["warm", "bright", "calm", "fun"];

      let db = null;
      let dataMode = "local";

      function initFirebaseIfEnabled() {
        if (!WEDDING.firebase?.enabled) return false;
        const cfg = WEDDING.firebase.config || {};
        const required = ["apiKey", "authDomain", "databaseURL", "projectId", "appId"];
        const ok = required.every((k) => String(cfg[k] || "").trim().length > 0);
        if (!ok) return false;

        try {
          firebase.initializeApp(cfg);
          db = firebase.database();
          dataMode = "shared";
          return true;
        } catch (e) {
          console.warn("Firebase init failed:", e);
          db = null;
          dataMode = "local";
          return false;
        }
      }

      function setDataModeUI() {
        const badge = $("#dataModeBadge");
        const note = $("#waveNote");
        const hint = $("#rsvpHint");
        if (dataMode === "shared") {
          badge && (badge.textContent = t("data.shared"));
          note && (note.textContent = t("data.noteShared"));
          hint && (hint.textContent = t("data.hintShared"));
        } else {
          badge && (badge.textContent = t("data.local"));
          note && (note.textContent = t("data.noteLocal"));
          hint && (hint.textContent = t("data.hintLocal"));
        }
      }

      function nowTs() {
        return Date.now();
      }

      function lsGet(key, fallback) {
        return safeJsonParse(localStorage.getItem(key) || "", fallback);
      }
      function lsSet(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      const emotionApi = {
        async push({ emotion, message }) {
          const item = { emotion, message: message || null, time: nowTs() };
          if (dataMode === "shared" && db) {
            await db.ref("wedding/emotions").push(item);
          } else {
            const list = lsGet(LS_KEYS.emotions, []);
            list.push(item);
            lsSet(LS_KEYS.emotions, list.slice(-400));
          }
        },
        onAdded(cb) {
          if (dataMode === "shared" && db) {
            db.ref("wedding/emotions")
              .limitToLast(300)
              .on("child_added", (snap) => {
                const d = snap.val();
                if (d) cb(d);
              });
          } else {
            let lastLen = 0;
            setInterval(() => {
              const list = lsGet(LS_KEYS.emotions, []);
              if (list.length > lastLen) {
                list.slice(lastLen).forEach(cb);
                lastLen = list.length;
              }
            }, 700);
          }
        },
      };

      const guestbookApi = {
        async add({ name, message }) {
          const item = {
            name: (name || "").trim().slice(0, 16) || t("guestbook.anonymous"),
            message: (message || "").trim().slice(0, 200),
            time: nowTs(),
          };
          if (!item.message) return false;

          if (dataMode === "shared" && db) {
            await db.ref("wedding/guestbook").push(item);
          } else {
            const list = lsGet(LS_KEYS.guestbook, []);
            list.unshift(item);
            lsSet(LS_KEYS.guestbook, list.slice(0, 80));
          }
          return true;
        },
        onList(cb) {
          if (dataMode === "shared" && db) {
            // 중복 리스너 방지
            if (guestbookApi._ref && guestbookApi._handler) {
              guestbookApi._ref.off("value", guestbookApi._handler);
            }
            guestbookApi._ref = db.ref("wedding/guestbook").limitToLast(80);
            guestbookApi._handler = (snap) => {
              const obj = snap.val() || {};
              const arr = Object.values(obj);
              arr.sort((a, b) => (b.time || 0) - (a.time || 0));
              cb(arr);
            };
            guestbookApi._ref.on("value", guestbookApi._handler);
          } else {
            cb(lsGet(LS_KEYS.guestbook, []));
          }
        },
      };

      const pollApi = {
        get() {
          const base = {};
          POLL_OPTIONS.forEach((id) => (base[id] = 0));
          const saved = lsGet(LS_KEYS.poll, base);
          return { ...base, ...(saved || {}) };
        },
        vote(id) {
          const cur = pollApi.get();
          cur[id] = (cur[id] || 0) + 1;
          lsSet(LS_KEYS.poll, cur);
          return cur;
        },
        clear() {
          localStorage.removeItem(LS_KEYS.poll);
          localStorage.removeItem(LS_KEYS.emotions);
          localStorage.removeItem(LS_KEYS.guestbook);
        },
      };

      // ================== INIT CONTENT ==================
      function bindContent() {
        const setText = (sel, val) => {
          const el = $(sel);
          if (el) el.textContent = val;
        };
        const setHtml = (sel, html) => {
          const el = $(sel);
          if (el) el.innerHTML = html;
        };
        const setHref = (sel, href) => {
          const el = $(sel);
          if (el) el.setAttribute("href", href || "#");
        };

        setText("#brandTitle", `${WEDDING.groomName} · ${WEDDING.brideName}`);
        setText("#brandDate", (WEDDING.dateText || "").replaceAll("년", ".").replaceAll("월", ".").replaceAll("일", "").slice(0, 12));

        setText("#groomName", WEDDING.groomName);
        setText("#brideName", WEDDING.brideName);
        setHtml("#heroMeta", `${escapeHtml(WEDDING.dateText)}<br />${escapeHtml(WEDDING.placeText)}`);

        setText("#pillDate", extractDateShort(WEDDING.dateText));
        setText("#pillPlace", WEDDING.placeShort || WEDDING.placeText);

        setText("#infoDate", WEDDING.dateText);
        setText("#infoPlace", WEDDING.placeText);
        setHref("#infoMapLink", WEDDING.naviLink);

        setText("#groomPhone", WEDDING.phone.groom);
        setText("#bridePhone", WEDDING.phone.bride);
        setText("#groomContactName", WEDDING.groomName);
        setText("#brideContactName", WEDDING.brideName);

        setHref("#groomTel", toTelHref(WEDDING.phone.groom));
        setHref("#brideTel", toTelHref(WEDDING.phone.bride));

        setHref("#groomWhatsapp", toWhatsappLink(WEDDING.phone.groom, currentCountry));
        setHref("#brideWhatsapp", toWhatsappLink(WEDDING.phone.bride, currentCountry));

        setHref("#btnNavi", WEDDING.naviLink);
        const mapLink = String(WEDDING.naviLink || "").trim();
        const embed = resolveMapEmbedUrl(mapLink, String(WEDDING.mapEmbedUrl || "").trim(), WEDDING.placeText, WEDDING.addressText);
        const mapFrame = $("#mapFrame");
        if (mapFrame) mapFrame.setAttribute("src", embed || "about:blank");
        const mapA = $("#mapLinkText");
        if (mapA) {
          mapA.setAttribute("href", mapLink || "#");
          mapA.textContent = mapLink ? shortenUrlForDisplay(mapLink) : "-";
        }

        // Gift
        setText("#groomHolder", WEDDING.gift.groomHolder);
        setText("#groomBank", WEDDING.gift.groomBank);
        setText("#brideHolder", WEDDING.gift.brideHolder);
        setText("#brideBank", WEDDING.gift.brideBank);
      }

      function digitsOnly(str) {
        return String(str || "").replace(/[^\d+]/g, "").replace(/\+/g, "");
      }

      function toTelHref(phone) {
        const raw = String(phone || "").trim();
        if (!raw) return "";
        const normalized = raw.replace(/[^\d+]/g, "");
        return `tel:${normalized}`;
      }

      function toWhatsappLink(phone, country) {
        const d = digitsOnly(phone);
        if (!d) return "";

        // already has country code
        if (d.startsWith("55") || d.startsWith("82")) return `https://wa.me/${d}`;

        const c = String(country || "").toUpperCase();
        if (c === "KR") {
          // 010xxxxxxxx -> 82 + 10xxxxxxxx
          const n = d.startsWith("0") ? d.slice(1) : d;
          return `https://wa.me/82${n}`;
        }
        // default BR
        // assume local (10~11 digits) -> prefix 55
        if (d.length >= 10 && d.length <= 11) return `https://wa.me/55${d}`;
        return `https://wa.me/${d}`;
      }

      function shortenUrlForDisplay(url) {
        const s = String(url || "").trim();
        if (!s) return "-";
        if (s.length <= 40) return s;
        return s.slice(0, 28) + "…" + s.slice(-10);
      }

      function resolveMapEmbedUrl(mapLink, mapEmbedUrl, placeText, addressText) {
        const explicit = String(mapEmbedUrl || "").trim();
        if (explicit) return explicit;
        // NOTE:
        // - goo.gl/maps, maps.app.goo.gl 등의 단축 링크는 iframe 임베드에서 깨질 수 있습니다(X-Frame-Options/리다이렉트 등).
        // - 가장 안정적인 방법은 "검색형 임베드" URL을 사용하는 것입니다.
        const q = encodeURIComponent(String(placeText || addressText || "").trim());
        if (!q) return "";
        return `https://maps.google.com/maps?q=${q}&output=embed`;
      }

      function appendQueryParam(url, key, value) {
        try {
          const u = new URL(url);
          if (!u.searchParams.has(key)) u.searchParams.set(key, value);
          return u.toString();
        } catch {
          // URL 파싱 실패 시 단순 문자열 처리
          if (!url) return "";
          const hasQ = url.includes("?");
          const sep = hasQ ? "&" : "?";
          if (url.includes(`${key}=`)) return url;
          return `${url}${sep}${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
        }
      }

      function extractDateShort(text) {
        const s = String(text || "");
        // KO: 2026년 5월 30일
        const mKo = s.match(/(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일/);
        if (mKo) {
          const yyyy = mKo[1];
          const mm = String(mKo[2]).padStart(2, "0");
          const dd = String(mKo[3]).padStart(2, "0");
          return `${yyyy}. ${mm}. ${dd}`;
        }
        // General: 2026. 05. 30 ...
        const mGen = s.match(/(\d{4})\D+(\d{1,2})\D+(\d{1,2})/);
        if (mGen) {
          const yyyy = mGen[1];
          const mm = String(mGen[2]).padStart(2, "0");
          const dd = String(mGen[3]).padStart(2, "0");
          return `${yyyy}. ${mm}. ${dd}`;
        }
        return s.slice(0, 12).trim();
      }

      // ================== GALLERY ==================
      async function buildGallery() {
        const grid = $("#galleryGrid");
        if (!grid) return;
        grid.innerHTML = "";

        const candidates =
          Array.isArray(WEDDING.galleryFiles) && WEDDING.galleryFiles.length > 0
            ? WEDDING.galleryFiles
            : generateGalleryCandidates(Number(WEDDING.galleryAutoMax || 11));

        const exists = await Promise.all(candidates.map((src) => imgExists(src).then((ok) => ({ src, ok }))));
        const files = Array.from(new Set(exists.filter((x) => x.ok).map((x) => x.src)));

        if (files.length === 0) {
          for (let i = 0; i < 6; i++) {
            const el = document.createElement("div");
            el.className = "gitem";
            el.style.background = "linear-gradient(135deg, rgba(200, 164, 107, 0.20), rgba(141, 106, 61, 0.10))";
            el.title = t("gallery.needFiles");
            grid.appendChild(el);
          }
          return;
        }

        files.forEach((src) => {
          const item = document.createElement("button");
          item.type = "button";
          item.className = "gitem";
          item.setAttribute("aria-label", t("gallery.open"));
          item.innerHTML = `<img src="${escapeHtml(src)}" alt="${escapeHtml(t("gallery.alt"))}" loading="lazy" />`;
          item.addEventListener("click", () => {
            $("#lightboxImg").src = src;
            openDialog("dlgLightbox");
          });
          grid.appendChild(item);
        });
      }

      function imgExists(src) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(true);
          img.onerror = () => resolve(false);
          img.src = src + (src.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(ASSET_CACHE_BUSTER);
        });
      }

      function generateGalleryCandidates(maxIndex) {
        const end = Number.isFinite(maxIndex) && maxIndex > 0 ? Math.floor(maxIndex) : 11;
        const exts = ["jpg", "jpeg", "JPG", "JPEG"];
        const dirs = ["assets/gallery/", ""];
        const out = [];

        for (let i = 1; i <= end; i++) {
          const n1 = String(i).padStart(2, "0");
          const n2 = String(i);
          const names = [n1, n2];
          for (const name of names) {
            for (const ext of exts) {
              for (const dir of dirs) {
                out.push(`${dir}${name}.${ext}`);
              }
            }
          }
        }
        return Array.from(new Set(out));
      }

      async function setHeroImage() {
        const candidates = Array.isArray(WEDDING.heroImageCandidates) ? WEDDING.heroImageCandidates : ["assets/hero.jpg"];
        for (const src of candidates) {
          // eslint-disable-next-line no-await-in-loop
          const ok = await imgExists(src);
          if (ok) {
            document.documentElement.style.setProperty("--hero-image", `url("${src}")`);
            return src;
          }
        }
        document.documentElement.style.removeProperty("--hero-image");
        return "";
      }

      // ================== CALENDAR (.ics download) ==================
      function downloadICS() {
        const dt = WEDDING.dateISO;
        if (!dt || !dt.includes("T")) {
          toast(t("toast.needDateISO"));
          return;
        }
        const start = toICS(dt);
        const end = toICS(addMinutes(dt, 60));
        const uid = `wedding-${Date.now()}@local`;
        const title =
          currentLang === "ko"
            ? `${WEDDING.groomName} · ${WEDDING.brideName} 결혼식`
            : `Casamento de ${WEDDING.groomName} & ${WEDDING.brideName}`;
        const loc = `${WEDDING.placeText} (${WEDDING.addressText})`;
        const baseUrl = location.href.split("?")[0];
        const desc = currentLang === "ko" ? `청첩장 링크: ${baseUrl}` : `Link do convite: ${baseUrl}`;
        const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Wedding//Invitation//Web
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICS(new Date().toISOString())}
DTSTART:${start}
DTEND:${end}
SUMMARY:${escapeICS(title)}
LOCATION:${escapeICS(loc)}
DESCRIPTION:${escapeICS(desc)}
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "wedding.ics";
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast(t("toast.downloaded"));
      }

      function escapeICS(s) {
        return String(s || "").replace(/\\/g, "\\\\").replace(/\n/g, "\\n").replace(/,/g, "\\,").replace(/;/g, "\\;");
      }

      function toICS(isoLike) {
        const d = typeof isoLike === "string" ? new Date(isoLike) : isoLike;
        const pad = (n) => String(n).padStart(2, "0");
        return (
          d.getUTCFullYear() +
          pad(d.getUTCMonth() + 1) +
          pad(d.getUTCDate()) +
          "T" +
          pad(d.getUTCHours()) +
          pad(d.getUTCMinutes()) +
          pad(d.getUTCSeconds()) +
          "Z"
        );
      }

      function addMinutes(isoLike, minutes) {
        const d = new Date(isoLike);
        d.setMinutes(d.getMinutes() + minutes);
        return d.toISOString();
      }

      // ================== INVITATION INTERACTIONS ==================
      function bindUI() {
        // Country / Language switch (BR=Português, KR=한국어)
        $$(".lang-btn").forEach((btn) => {
          btn.addEventListener("click", () => setCountry(btn.getAttribute("data-country")));
        });

        $("#btnCalendar")?.addEventListener("click", downloadICS);

        $$("[data-close]").forEach((btn) => {
          btn.addEventListener("click", () => closeDialog(btn.getAttribute("data-close")));
        });

        $("#btnCopyAddr")?.addEventListener("click", () => copyText(WEDDING.addressText));
        $("#btnCopyMapLink")?.addEventListener("click", () => copyText(WEDDING.naviLink || ""));
        $("#btnShareMap")?.addEventListener("click", async () => {
          const url = String(WEDDING.naviLink || "").trim();
          if (!url) return;
          const title = currentLang === "ko" ? "구글 지도" : "Google Maps";
          const text = currentLang === "ko" ? "장소 링크를 공유합니다." : "Sharing the location link.";
          if (navigator.share) {
            try {
              await navigator.share({ title, text, url });
              return;
            } catch {
              // 사용자가 취소했거나 실패 → 복사로 폴백
            }
          }
          await copyText(url);
        });

        $$("[data-copy]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const sel = btn.getAttribute("data-copy");
            const el = sel ? document.querySelector(sel) : null;
            const text = (el?.textContent || "").trim();
            if (text) copyText(text);
          });
        });

        // Guestbook
        $("#btnGbSubmit")?.addEventListener("click", async () => {
          const ok = await guestbookApi.add({
            name: $("#gbName").value,
            message: $("#gbMessage").value,
          });
          if (!ok) return toast(t("toast.needMessage"));
          $("#gbMessage").value = "";
          toast(t("toast.leftMessage"));
          renderGuestbook();
        });

        // Poll
        $("#btnClearLocal")?.addEventListener("click", () => {
          pollApi.clear();
          toast(t("toast.cleared"));
          renderPoll();
          renderGuestbook();
        });

        $("#btnExport")?.addEventListener("click", async () => {
          const payload = {
            mode: dataMode,
            exportedAt: new Date().toISOString(),
            local: {
              emotions: lsGet(LS_KEYS.emotions, []),
              guestbook: lsGet(LS_KEYS.guestbook, []),
              poll: pollApi.get(),
            },
          };
          await copyText(JSON.stringify(payload, null, 2));
        });

        // Emotions buttons
        let lastSent = 0;
        const COOLDOWN = 650;
        $$(".chip").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const now = nowTs();
            if (now - lastSent < COOLDOWN) return;
            lastSent = now;

            const emotion = btn.getAttribute("data-emotion");
            const msg = ($("#waveMessage").value || "").trim();
            if (!EMOTIONS[emotion]) return;
            $("#waveMessage").value = "";
            await emotionApi.push({ emotion, message: msg });
            toast(t("toast.joined"));
            bumpLocalWave(emotion, msg);
          });
        });
      }

      // ================== RENDER: Poll ==================
      function renderPoll() {
        const el = $("#poll");
        if (!el) return;
        const counts = pollApi.get();
        const total = Object.values(counts).reduce((a, b) => a + (b || 0), 0) || 0;
        el.innerHTML = "";

        POLL_OPTIONS.forEach((id) => {
          const label = t(`poll.option.${id}`);
          const c = counts[id] || 0;
          const pct = total === 0 ? 0 : Math.round((c / total) * 100);
          const item = document.createElement("button");
          item.type = "button";
          item.className = "poll-item";
          item.setAttribute("aria-label", t("poll.ariaVote", { label }));
          item.innerHTML = `
            <div class="poll-head">
              <strong>${escapeHtml(label)}</strong>
              <span>${escapeHtml(t("poll.votes", { count: c, pct }))}</span>
            </div>
            <div class="bar"><i style="width:${pct}%"></i></div>
          `;
          item.addEventListener("click", () => {
            pollApi.vote(id);
            renderPoll();
            toast(t("toast.voted"));
          });
          el.appendChild(item);
        });
      }

      // ================== RENDER: Guestbook ==================
      function renderGuestbook() {
        guestbookApi.onList((list) => {
          const root = $("#guestbookList");
          if (!root) return;
          root.innerHTML = "";
          const items = (list || []).slice(0, 12);
          if (items.length === 0) {
            const empty = document.createElement("div");
            empty.className = "muted";
            empty.style.fontSize = "13px";
            empty.textContent = t("guestbook.empty");
            root.appendChild(empty);
            return;
          }
          items.forEach((it) => {
            const card = document.createElement("div");
            card.className = "card";
            card.style.boxShadow = "none";
            card.style.background = "rgba(255,255,255,.68)";
            const when = new Date(it.time || Date.now());
            const stamp = `${when.getFullYear()}.${String(when.getMonth() + 1).padStart(2, "0")}.${String(when.getDate()).padStart(2, "0")}`;
            card.innerHTML = `
              <div style="display:flex;justify-content:space-between;gap:10px;align-items:baseline">
                <strong style="font-size:14px">${escapeHtml(it.name || t("guestbook.anonymous"))}</strong>
                <span class="muted" style="font-size:12px">${stamp}</span>
              </div>
              <div style="margin-top:8px;font-size:14px;line-height:1.7">${escapeHtml(it.message || "")}</div>
            `;
            root.appendChild(card);
          });
        });
      }

      // ================== Wave Canvas (invitation) ==================
      const wave = { canvas: null, ctx: null, t: 0, energy: 0.25, flash: 0, lastEmotion: "calm" };

      function initWaveCanvas() {
        wave.canvas = $("#waveCanvas");
        if (!wave.canvas) return;
        wave.ctx = wave.canvas.getContext("2d");

        const resize = () => {
          const rect = wave.canvas.getBoundingClientRect();
          const dpr = Math.min(window.devicePixelRatio || 1, 2);
          wave.canvas.width = Math.floor(rect.width * dpr);
          wave.canvas.height = Math.floor(rect.height * dpr);
          wave.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        };
        window.addEventListener("resize", resize, { passive: true });
        resize();
        drawWave();
      }

      function bumpLocalWave(emotion, message) {
        wave.lastEmotion = emotion;
        wave.energy = Math.min(wave.energy + 1.2 + Math.min((message || "").length / 18, 1.6), 18);
        if (wave.energy > 16) wave.flash = 1;
      }

      function drawWave() {
        if (!wave.ctx || !wave.canvas) return;
        const rect = wave.canvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;
        const ctx = wave.ctx;
        ctx.clearRect(0, 0, w, h);

        wave.energy *= 0.985;
        wave.energy = Math.max(wave.energy, 0.22);
        wave.t += 0.012 + wave.energy * 0.002;

        const bg = ctx.createLinearGradient(0, 0, 0, h);
        bg.addColorStop(0, "rgba(255,255,255,0.00)");
        bg.addColorStop(1, "rgba(255,255,255,0.45)");
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        const layers = Object.entries(EMOTIONS);
        layers.forEach(([key, l], idx) => {
          ctx.strokeStyle = l.color;
          ctx.globalAlpha = key === wave.lastEmotion ? 0.35 : 0.2;
          ctx.lineWidth = key === wave.lastEmotion ? 2.6 : 2.0;
          ctx.beginPath();
          for (let x = 0; x <= w; x += 2) {
            const y = h / 2 + Math.sin(x * l.freq + wave.t + idx) * (26 + wave.energy * 3.2) + Math.sin(x * 0.012 + wave.t * 0.7) * 7;
            if (x === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
        });

        if (wave.flash > 0) {
          ctx.globalAlpha = 1;
          ctx.fillStyle = `rgba(255,255,255,${wave.flash})`;
          ctx.fillRect(0, 0, w, h);
          wave.flash *= 0.84;
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(drawWave);
      }

      // ================== Screen mode (venue display) ==================
      function initScreenMode() {
        const canvas = document.getElementById("canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");

        function resize() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resize, { passive: true });
        resize();

        let energy = 0;
        let flash = 0;
        let t = 0;

        let audioCtx = null,
          osc = null,
          gain = null;
        const canAudio = !!(window.AudioContext || window.webkitAudioContext);
        const enableAudio = () => {
          if (!canAudio || audioCtx) return;
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          osc = audioCtx.createOscillator();
          gain = audioCtx.createGain();
          osc.type = "sine";
          osc.frequency.value = 120;
          gain.gain.value = 0;
          osc.connect(gain).connect(audioCtx.destination);
          osc.start();
        };
        document.body.addEventListener(
          "click",
          () => {
            enableAudio();
            if (audioCtx?.state && audioCtx.state !== "running") audioCtx.resume();
          },
          { once: true }
        );

        emotionApi.onAdded((d) => {
          if (!d || !EMOTIONS[d.emotion]) return;
          energy += 1.35;
          if (d.message) {
            energy += Math.min(String(d.message).length / 15, 2);
            showMessage(String(d.message));
          }
          if (energy > 25) flash = 1;
        });

        function showMessage(text) {
          const layer = document.getElementById("message-layer");
          const el = document.createElement("div");
          el.className = "message";
          el.textContent = text;
          layer.appendChild(el);
          setTimeout(() => el.remove(), 5000);
        }

        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          energy *= 0.985;
          energy = Math.max(energy, 0.3);

          if (gain && osc) {
            gain.gain.value = Math.min(energy / 40, 0.15);
            osc.frequency.value = 100 + energy * 8;
          }

          Object.values(EMOTIONS).forEach((l) => {
            ctx.strokeStyle = l.color;
            ctx.globalAlpha = 0.35;
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < canvas.width; x++) {
              const y = canvas.height / 2 + Math.sin(x * l.freq + t) * (80 + energy * 4);
              ctx.lineTo(x, y);
            }
            ctx.stroke();
          });

          if (flash > 0) {
            ctx.fillStyle = `rgba(255,255,255,${flash})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            flash *= 0.85;
          }

          ctx.globalAlpha = 1;
          t += 0.01 + energy * 0.002;
          requestAnimationFrame(draw);
        }
        draw();
      }

      // ================== BOOT ==================
      initCountry(resolveInitialCountry());
      initFirebaseIfEnabled();
      setDataModeUI();
      bindContent();
      bindUI();
      renderPoll();
      renderGuestbook();

      if (mode === "screen") {
        initScreenMode();
      } else {
        setHeroImage();
        initWaveCanvas();
        buildGallery();
      }
    </script>
  </body>
</html>

